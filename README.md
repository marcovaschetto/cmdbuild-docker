# CMDBuild + openMAINT — Docker Deployment
## 🧰 Requirements
- Linux (or WSL2) with **Docker** and the **Docker Compose plugin**
- Minimum resources: 2 vCPU, 4 GB RAM, 5 GB free disk space
- Default ports: `8080` (CMDBuild), `8081` (openMAINT)

---

## 🚀 Quick start

1. **Clone** the repository and move into the project folder:
   ```bash
   git clone <repo-url> cmdbuild-docker
   cd cmdbuild-docker
   ```

2. **Initialize** the `.env` file with generated credentials:
   ```bash
   ./init.sh
   ```
   This command creates `.env` from `.env.example` with random passwords and a default backup schedule.

3. **Start the main stack** (CMDBuild + openMAINT + DB):
   ```bash
   docker compose up -d
   ```

4. **Application access**
   - CMDBuild: http://localhost:8080
   - openMAINT: http://localhost:8081

> Note: there are separate compose files for **CMDBuild only** (`docker-compose.cmdbuild.yml`) and **openMAINT only** (`docker-compose.openmaint.yml`). Use them if you prefer to run a single application at a time:
> ```bash
> docker compose -f docker-compose.cmdbuild.yml up -d
> docker compose -f docker-compose.openmaint.yml up -d
> ```

---

## ⚙️ Database configuration
Variables live in `.env` (generated by `init.sh`). The application containers automatically inject the `database.conf` file into their respective webapps.

Main variables:
- `CMDBUILD_DB_NAME`, `CMDBUILD_DB_USER`, `CMDBUILD_DB_PASSWORD`, `CMDBUILD_DB_HOST`
- `OPENMAINT_DB_NAME`, `OPENMAINT_DB_USER`, `OPENMAINT_DB_PASSWORD`, `OPENMAINT_DB_HOST`
- Cluster administrative user: `CMDBUILD_ADMIN_*` / `OPENMAINT_ADMIN_*`

**First run:** the scripts under `config/database/` create **users and databases**.  
The **application schema creation** (CMDBuild/openMAINT) is performed by the application (CLI) when needed.

> If you want to force schema creation via CLI (first time only):
> ```bash
> # CMDBuild example
> docker exec -it cmdbuild bash -lc '/usr/local/tomcat/webapps/cmdbuild/cmdbuild.sh dbconfig recreate empty -configfile /usr/local/tomcat/conf/cmdbuild/database.conf'
> 
> # openMAINT example
> docker exec -it openmaint bash -lc '/usr/local/tomcat/webapps/openmaint/cmdbuild.sh dbconfig recreate empty -configfile /usr/local/tomcat/conf/openmaint/database.conf'
> ```
> For subsequent runs, use:
> ```bash
> # Apply any schema patches (idempotent)
> docker exec -it cmdbuild bash -lc '/usr/local/tomcat/webapps/cmdbuild/cmdbuild.sh dbconfig patch -configfile /usr/local/tomcat/conf/cmdbuild/database.conf'
> docker exec -it openmaint  bash -lc '/usr/local/tomcat/webapps/openmaint/cmdbuild.sh dbconfig patch -configfile /usr/local/tomcat/conf/openmaint/database.conf'
> ```

---

## 💾 Backup (optional)
A `backup` container performs **periodic dumps** and stores files in `./volumes/backup`.  
Configure the schedule with `BACKUP_SCHEDULE_CRON` in `.env` (default: every day at 02:00).

> Backups include: database dumps and application configurations useful for restore.

---

## 🗂️ Repository structure

```
.
├── .env.example
├── .env
├── docker-compose.yml                 # Full stack (cmdbuild + openmaint + DB + backup)
├── docker-compose.cmdbuild.yml        # CMDBuild only
├── docker-compose.openmaint.yml       # openMAINT only
├── config/
│   └── database/
│       ├── init-cmdbuild.sh
│       └── init-openmaint.sh
├── docker/
│   ├── cmdbuild-app/
│   │   ├── Dockerfile
│   │   └── entrypoint.sh              # Injects database.conf
│   ├── openmaint-app/
│   │   ├── Dockerfile
│   │   └── entrypoint.sh              # Injects database.conf
│   └── backup/
│       ├── Dockerfile
│       ├── entrypoint.sh
│       ├── backup.sh
│       └── restore.sh
├── scripts/
│   ├── docker.sh
│   ├── start.sh
│   ├── stop.sh
│   └── maintenance.sh
└── volumes/
    └── backup/                        # Backup artifacts
```

## 📋 Versions matrix
Based on CMDBuild engine 4.0.4.
| Component | Tag/Version |
|---|---|
| CMDBuild WAR | 2.4 | 
| openMAINT WAR | 2.4 | 
| alpine | 3.20 | 
| cmdbuild-app | latest | 
| openmaint-app | latest | 
| backup-app | latest | 
| nginx | 1.29-alpine | 
| postgis 17-3.5 | postgis/postgis:17-3.5 |
| tomcat | jdk21-openjdk-bookworm |

## 🔐 Security & best practices
1. **Do not** commit `.env`. Credentials are generated by `init.sh`.
2. Consider using `sslmode=require` in JDBC strings if your Postgres exposes TLS.
3. Run application containers as **non‑root** (already configured in the Dockerfiles).
4. Set up **off‑site** backups and perform periodic **restore tests**.

---

## 🧭 Project status — *To do*
- **Backup**: implement the backup container and directory structure.
- **Healthcheck**: add HTTP readiness/liveness for the apps and DB reachability checks.
- **Reverse proxy/HTTPS**: optional Nginx or Traefik integration (environment variables `NGINX_*` already envisioned but not included in the default stack).
- **Upgrade documentation**: guide for migrating from previous CMDBuild/openMAINT versions using `dbconfig patch` and a compatibility checklist.

---

## 📄 License & Credits
Project maintained by **SpaceIndustries**.  
Inspired and reworked from community initiatives (e.g., `itmicus/cmdbuild_docker`).