# CMDBuild + openMAINT â€” Docker Deployment
## ğŸ§° Requirements
- Linux (or WSL2) with **Docker** and the **Docker Compose plugin**
- Minimum resources: 2 vCPU, 4 GB RAM, 5 GB free disk space
- Default ports: `8080` (CMDBuild), `8081` (openMAINT)

---

## ğŸš€ Quick start

1. **Clone** the repository and move into the project folder:
   ```bash
   git clone <repo-url> cmdbuild-docker
   cd cmdbuild-docker
   ```

2. **Initialize** the `.env` file with generated credentials:
   ```bash
   ./init.sh
   ```
   This command creates `.env` from `.env.example` with random passwords and a default backup schedule.

3. **Start the main stack** (CMDBuild + openMAINT + DB):
   ```bash
   docker compose up -d
   ```

4. **Application access**
   - CMDBuild: http://localhost:8080
   - openMAINT: http://localhost:8081

> Note: there are separate compose files for **CMDBuild only** (`docker-compose.cmdbuild.yml`) and **openMAINT only** (`docker-compose.openmaint.yml`). Use them if you prefer to run a single application at a time:
> ```bash
> docker compose -f docker-compose.cmdbuild.yml up -d
> docker compose -f docker-compose.openmaint.yml up -d
> ```

---

## âš™ï¸ Database configuration
Variables live in `.env` (generated by `init.sh`). The application containers automatically inject the `database.conf` file into their respective webapps.

Main variables:
- `CMDBUILD_DB_NAME`, `CMDBUILD_DB_USER`, `CMDBUILD_DB_PASSWORD`, `CMDBUILD_DB_HOST`
- `OPENMAINT_DB_NAME`, `OPENMAINT_DB_USER`, `OPENMAINT_DB_PASSWORD`, `OPENMAINT_DB_HOST`
- Cluster administrative user: `CMDBUILD_ADMIN_*` / `OPENMAINT_ADMIN_*`

**First run:** the scripts under `config/database/` create **users and databases**.  
The **application schema creation** (CMDBuild/openMAINT) is performed by the application (CLI) when needed.

> If you want to force schema creation via CLI (first time only):
> ```bash
> # CMDBuild example
> docker exec -it cmdbuild bash -lc '/usr/local/tomcat/webapps/cmdbuild/cmdbuild.sh dbconfig recreate empty -configfile /usr/local/tomcat/conf/cmdbuild/database.conf'
> 
> # openMAINT example
> docker exec -it openmaint bash -lc '/usr/local/tomcat/webapps/openmaint/cmdbuild.sh dbconfig recreate empty -configfile /usr/local/tomcat/conf/openmaint/database.conf'
> ```
> For subsequent runs, use:
> ```bash
> # Apply any schema patches (idempotent)
> docker exec -it cmdbuild bash -lc '/usr/local/tomcat/webapps/cmdbuild/cmdbuild.sh dbconfig patch -configfile /usr/local/tomcat/conf/cmdbuild/database.conf'
> docker exec -it openmaint  bash -lc '/usr/local/tomcat/webapps/openmaint/cmdbuild.sh dbconfig patch -configfile /usr/local/tomcat/conf/openmaint/database.conf'
> ```

---

## ğŸ’¾ Backup (optional)
A `backup` container performs **periodic dumps** and stores files in `./volumes/backup`.  
Configure the schedule with `BACKUP_SCHEDULE_CRON` in `.env` (default: every day at 02:00).

> Backups include: database dumps and application configurations useful for restore.

---

## ğŸ—‚ï¸ Repository structure

```
.
â”œâ”€â”€ .env.example
â”œâ”€â”€ .env
â”œâ”€â”€ docker-compose.yml                 # Full stack (cmdbuild + openmaint + DB + backup)
â”œâ”€â”€ docker-compose.cmdbuild.yml        # CMDBuild only
â”œâ”€â”€ docker-compose.openmaint.yml       # openMAINT only
â”œâ”€â”€ config/
â”‚   â””â”€â”€ database/
â”‚       â”œâ”€â”€ init-cmdbuild.sh
â”‚       â””â”€â”€ init-openmaint.sh
â”œâ”€â”€ docker/
â”‚   â”œâ”€â”€ cmdbuild-app/
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â””â”€â”€ entrypoint.sh              # Injects database.conf
â”‚   â”œâ”€â”€ openmaint-app/
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â””â”€â”€ entrypoint.sh              # Injects database.conf
â”‚   â””â”€â”€ backup/
â”‚       â”œâ”€â”€ Dockerfile
â”‚       â”œâ”€â”€ entrypoint.sh
â”‚       â”œâ”€â”€ backup.sh
â”‚       â””â”€â”€ restore.sh
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ docker.sh
â”‚   â”œâ”€â”€ start.sh
â”‚   â”œâ”€â”€ stop.sh
â”‚   â””â”€â”€ maintenance.sh
â””â”€â”€ volumes/
    â””â”€â”€ backup/                        # Backup artifacts
```

## ğŸ“‹ Versions matrix
Based on CMDBuild engine 4.0.4.
| Component | Tag/Version |
|---|---|
| CMDBuild WAR | 2.4 | 
| openMAINT WAR | 2.4 | 
| alpine | 3.20 | 
| cmdbuild-app | latest | 
| openmaint-app | latest | 
| backup-app | latest | 
| nginx | 1.29-alpine | 
| postgis 17-3.5 | postgis/postgis:17-3.5 |
| tomcat | jdk21-openjdk-bookworm |

## ğŸ” Security & best practices
1. **Do not** commit `.env`. Credentials are generated by `init.sh`.
2. Consider using `sslmode=require` in JDBC strings if your Postgres exposes TLS.
3. Run application containers as **nonâ€‘root** (already configured in the Dockerfiles).
4. Set up **offâ€‘site** backups and perform periodic **restore tests**.

---

## ğŸ§­ Project status â€” *To do*
- **Backup**: implement the backup container and directory structure.
- **Healthcheck**: add HTTP readiness/liveness for the apps and DB reachability checks.
- **Reverse proxy/HTTPS**: optional Nginx or Traefik integration (environment variables `NGINX_*` already envisioned but not included in the default stack).
- **Upgrade documentation**: guide for migrating from previous CMDBuild/openMAINT versions using `dbconfig patch` and a compatibility checklist.

---

## ğŸ“„ License & Credits
Project maintained by **SpaceIndustries**.  
Inspired and reworked from community initiatives (e.g., `itmicus/cmdbuild_docker`).